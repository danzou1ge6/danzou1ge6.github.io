<!doctype html><html lang=en><head><title>Audlyrics :: Danzou1ge6</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Audacious 的歌词工具 on KDE Plasmashell"><meta name=keywords content="audacious,rust,KDE"><meta name=robots content="noodp"><link rel=canonical href=/posts/audlyrics/><link rel=stylesheet href=/styles.css><link rel="shortcut icon" href=/img/theme-colors/blue.png><link rel=apple-touch-icon href=/img/theme-colors/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Audlyrics"><meta property="og:description" content="Audacious 的歌词工具 on KDE Plasmashell"><meta property="og:url" content="/posts/audlyrics/"><meta property="og:site_name" content="Danzou1ge6"><meta property="og:image" content="/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-02-06 18:21:30 +0800 +0800"></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Danzou1ge6</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li><li><a href=/links>Links</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li><li><a href=/links>Links</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/posts/audlyrics/>Audlyrics</a></h1><div class=post-meta><time class=post-date>2023-02-06 ::</time></div><span class=post-tags>#<a href=/tags/music/>music</a>&nbsp;</span><div class=post-content><div><h2 id=动机>动机<a href=#动机 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>偶然发现一直在用的音乐播放器 Audacious 附带了一个命令行工具 <code>audtool</code> ，可以控制播放和获取播放信息。</p><p>这东西好啊，一直以来在 Plasmashell 上显示歌词的执念终于可以满足了。</p><h2 id=技术路线>技术路线<a href=#技术路线 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>说起 Plasmashell 当然得是 Plamoid ，写 Plasmoid 当然得用 QML 。
但是吧， QML 框架好像不能直接访问文件系统，也不能执行命令，而要做到这些就得用 C++ ，这就很头疼了。</p><p>所以思索之下，我最终选择了用 Rust 写一个服务器，然后 QML 只负责展示。</p><p>Rust 的服务器框架随便选了个 Hyper 。</p><h2 id=实现>实现<a href=#实现 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>思路很简单，在服务端开子进程执行 <code>audtool</code> ，获取当前曲目位置和播放时间，刚好我的歌词就存在曲目边上，和音频文件同名。</p><p>从歌词文件里读出来 LRC 格式的文本，然后解析后存起来，前端轮询的时候根据播放时间返回当前句子就行了。</p><p>QML 懒得学，但是刚好看见过一个叫 <code>ypm-lyrics</code> 的 Plasmoid ，这个是用来显示网易云第三方客户端 YesplayMusic 的歌词的，就直接拿来用了。</p><p>在和 Rust 的异步生命周期检查搏斗许久之后，终于搞定了服务端。</p><p>从中总结出来的经验是：闭包写短点，要不然容易晕。。。（汗</p><p>然后为了无感启动和关闭服务端，又为了不想让服务端一直开着（虽然基本不会占资源），在启动服务端时会把 Audacious 作为子进程启动，然后守护 Audacious 退出。</p><div class=collapsable-code><input id=1 type=checkbox>
<label for=1><span class=collapsable-code__language>rust</span>
<span class=collapsable-code__title>服务器核心代码</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-rust><code>

    let mut child = Command::new(&#34;audacious&#34;).spawn()
        .expect(&#34;Cannot start audacious. Is it Installed?&#34;);


    let state = Arc::new(Mutex::new(State::new()));

    let make_service = make_service_fn(move |_: &amp;AddrStream| {
        let state = state.clone();

        let service = service_fn(
        move |req: Request&lt;Body&gt;| {
            handle(state.clone(), req)
        });

        async move {
            Ok::&lt;_, Infallible&gt;(service)
        }
    });

    let addr = ([127, 0, 0, 1], 30123).into();
    let server = Server::bind(&amp;addr).serve(make_service);

    let grace = server.with_graceful_shutdown(async move {
        match child.wait().await {
            Ok(code) =&gt; println!(&#34;Audacious returned with {}&#34;, code),
            Err(e) =&gt; println!(&#34;Audacious returned with IoError {:?}&#34;, e)
        };
    });

    if let Err(e) = grace.await {
        eprintln!(&#34;Server error: {}&#34;, e);
    }
</code></pre></div><p>端口直接写死了。</p><img src=/emoji/bailan.jpg height=150px><h2 id=效果>效果<a href=#效果 class=hanchor arialabel=Anchor>&#8983;</a></h2><figure class=center><img src=playing.png alt=Playing><figcaption class=right>Playing</figcaption></figure><figure class=center><img src=paused.png alt=Paused><figcaption class=right>Paused</figcaption></figure><p>源代码可以在 <a href=https://github.com/danzou1ge6/audlyrics/>Github</a> 找到。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/hello_world/><span class=button__text>hello_world</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>